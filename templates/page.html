<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>GitLab Explorer</title>
<style>
body { font-family: sans-serif; margin: 20px auto; max-width: 70%; }
table { border-collapse: collapse; width: 100%; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 6px; text-align: left; vertical-align: top; }
th { background: #f5f5f5; }
select { min-width: 200px; }
.error { color: red; }
.group { margin-top: 20px; border: 1px solid #ddd; padding: 10px; border-radius: 8px; }
.group-header { cursor: pointer; display: flex; align-items: center; gap: 8px; }
.toggle-btn { margin-right: 8px; font-weight: bold; cursor: pointer; user-select: none; }
.pipeline-section { margin: 0; padding: 0; border: none; display: none; }
.pipeline-error { color: red; }
.stage-row { background: #f9f9f9; }
.status-btn { padding: 2px 8px; border-radius: 6px; font-size: 12px; font-weight: bold; color: white; border: none; cursor: default; min-width: 70px; text-align: center; }
.status-failed { background-color: red; }
.status-manual { background-color: orange; }
.status-success { background-color: green; }

/* кнопка Запустить */
.run-btn { padding: 2px 8px; margin-left: 6px; border-radius: 6px; font-size: 12px; font-weight: bold; border: 1px solid green; background: green; color: white; cursor: pointer; min-width: 90px; text-align: center; }
.run-btn:hover { background: #0056b3; }

/* кнопка Перезапустить */
.retry-btn { padding: 2px 8px; margin-left: 6px; border-radius: 6px; font-size: 12px; font-weight: bold; border: 1px solid #007bff; background: #007bff; color: white; cursor: pointer; min-width: 90px; text-align: center; }
.retry-btn:hover { background: #0056b3; }

/* кнопка Отмена */
.cancel-btn { padding: 2px 8px; margin-left: 6px; border-radius: 6px; font-size: 12px; font-weight: bold; border: 1px solid red; background: red; color: white; cursor: pointer; min-width: 90px; text-align: center; }
.cancel-btn:hover { background: red; }

/* общий контейнер для выравнивания */
.job-line { display: flex; align-items: center; gap: 8px; }
.job-name { flex: 1; }
</style>
</head>
<body>
<h1>GitLab Explorer</h1>

<form method="POST" action="/" onsubmit="setTimeout(() => { document.querySelector('input[name=token]').value=''; }, 100)">
    <label>GitLab OAuth Token:&nbsp;</label>
    <input type="password" name="token" size="60">
    <button type="submit">Загрузить</button>
</form>

{{if .Error}}
<p class="error">Ошибка: {{.Error}}</p>
{{end}}

{{range $i, $g := .Groups}}
<div class="group">
    <div class="group-header" onclick="toggleGroup('group{{$i}}')">
        <span id="btn-group{{$i}}" class="toggle-btn">[+]</span>
        <h2 style="margin:0">Группа: {{$g.Name}} ({{$g.Path}})</h2>
    </div>

    <div id="group{{$i}}" class="group-content" style="display:none; margin-top:8px;">
        <table>
            <tr>
                <th>Проект</th>
                <th>Реф</th>
                <th>Действие</th>
                <th>Джоб / Bridge</th>
            </tr>
            {{range $j, $p := $g.Projects}}
            <tr>
                <td>{{.Name}}</td>
                <td>
                    <select id="ref-{{$i}}-{{$j}}">
                        {{range .Refs}}<option>{{.}}</option>{{else}}<option>—</option>{{end}}
                    </select>
                </td>
                <td>
                    <button onclick="loadPipeline('{{$i}}', '{{$j}}', '{{$p.ID}}')">Загрузить пайплайн</button>
                </td>
                <td>
                    <div id="pipeline-{{$i}}-{{$j}}" class="pipeline-section">
                        <p class="pipeline-error" id="pipeline-error-{{$i}}-{{$j}}" style="display:none;"></p>
                        <table style="width:100%;">
                            <tbody id="jobs-{{$i}}-{{$j}}"></tbody>
                        </table>
                    </div>
                </td>
            </tr>
            {{end}}
            {{if not $g.Projects}}
            <tr><td colspan="4">Нет проектов</td></tr>
            {{end}}
        </table>
    </div>
</div>
{{end}}

<script>
function toggleGroup(id) {
    const content = document.getElementById(id);
    const btn = document.getElementById("btn-" + id);
    const isHidden = window.getComputedStyle(content).display === "none";
    content.style.display = isHidden ? "block" : "none";
    btn.textContent = isHidden ? "[−]" : "[+]";
}

function getStatusClass(status) {
    switch(status) {
        case 'failed': return 'status-btn status-failed';
        case 'manual': return 'status-btn status-manual';
        case 'success': return 'status-btn status-success';
        default: return 'status-btn';
    }
}

async function loadPipeline(groupIdx, projIdx, projectId) {
    const select = document.getElementById('ref-' + groupIdx + '-' + projIdx);
    const ref = select.value;
    if (ref === '—') { alert('Выберите реф'); return; }

    const section = document.getElementById('pipeline-' + groupIdx + '-' + projIdx);
    const errorP = document.getElementById('pipeline-error-' + groupIdx + '-' + projIdx);
    const jobsTbody = document.getElementById('jobs-' + groupIdx + '-' + projIdx);

    section.style.display = 'block';
    errorP.style.display = 'none';
    jobsTbody.innerHTML = '';

    try {
        const response = await fetch('/pipeline?project_id=' + projectId + '&ref=' + encodeURIComponent(ref));
        if (!response.ok) throw new Error('HTTP error ' + response.status);
        const data = await response.json();
        if (data.error) { errorP.textContent = data.error; errorP.style.display = 'block'; return; }
        if (!data.jobs) data.jobs = []; if (!data.bridges) data.bridges = [];

        const stages = {};
        data.jobs.forEach(job => { if(!stages[job.stage]) stages[job.stage]=[]; stages[job.stage].push(job); });

        // обычные jobs
        Object.keys(stages).forEach(stage => {
            const stageTr = document.createElement('tr');
            stageTr.className = 'stage-row'; 
            stageTr.innerHTML = '<td><b>Stage:</b> ' + stage + '</td>';
            jobsTbody.appendChild(stageTr);

            stages[stage].forEach(job => {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td style="padding-left:20px;">' +
                               '<div class="job-line">' +
                                 '<span class="job-name">' + job.name + '</span>' +
                                 '<button class="' + getStatusClass(job.status) + '">' + job.status + '</button>' +
                                 '<button class="run-btn" onclick="playJob(' + groupIdx + ',' + projIdx + ',' + projectId + ',' + job.id + ')">Запустить</button>' +
                                 '<button class="retry-btn" onclick="alert(\'Перезапуск пока не реализован\')">Перезапустить</button>' +
                                 '<button class="cancel-btn" onclick="alert(\'Отмена пока не реализована\')">Отменить</button>' +
                               '</div></td>';
                jobsTbody.appendChild(tr);
            });
        });

        // bridges и downstream jobs
        data.bridges.forEach((bridge) => {
            const bridgeTr = document.createElement('tr');
            bridgeTr.className = 'stage-row';
            bridgeTr.innerHTML = '<td><b>Stage:</b> ' + bridge.name + '</td>';
            jobsTbody.appendChild(bridgeTr);

            if (bridge.downstream_jobs && bridge.downstream_jobs.length > 0) {
                const bStages = {};
                bridge.downstream_jobs.forEach(job => {
                    if (!bStages[job.stage]) bStages[job.stage] = [];
                    bStages[job.stage].push(job);
                });

                Object.keys(bStages).reverse().forEach(stage => {
                    const stageTrDS = document.createElement('tr');
                    stageTrDS.className = 'stage-row';
                    stageTrDS.innerHTML = '<td style="padding-left:10px;"><b>Stage:</b> ' + stage + '</td>';
                    jobsTbody.appendChild(stageTrDS);

                    bStages[stage].forEach(job => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = '<td style="padding-left:30px;">' +
                                       '<div class="job-line">' +
                                         '<span class="job-name">' + job.name + '</span>' +
                                         '<button class="' + getStatusClass(job.status) + '">' + job.status + '</button>' +
                                         '<button class="run-btn" onclick="playJob(' + groupIdx + ',' + projIdx + ',' + projectId + ',' + job.id + ')">Запустить</button>' +
                                         '<button class="retry-btn" onclick="alert(\'Перезапуск пока не реализован\')">Перезапустить</button>' +
                                         '<button class="cancel-btn" onclick="alert(\'Отмена пока не реализована\')">Отменить</button>' +
                                       '</div></td>';
                        jobsTbody.appendChild(tr);
                    });
                });
            }
        });

    } catch (err) { errorP.textContent = 'Ошибка: ' + err.message; errorP.style.display='block'; }
}

// Запуск jobs
async function playJob(groupIdx, projIdx, projectId, jobId) {
    try {
        const response = await fetch(
            '/playjob?project_id=' + projectId +
            '&job_id=' + jobId,
            { method: 'POST' }
        );

        if (!response.ok) throw new Error('HTTP error ' + response.status);
        const data = await response.json();
        if (data.error) {
            alert('Ошибка: ' + data.error);
        } else {
            alert('Джоба запущена!');
            // через 5 секунд обновим пайплайн
            setTimeout(() => {
                loadPipeline(groupIdx, projIdx, projectId);
            }, 5000);
        }
    } catch (err) {
        alert('Ошибка: ' + err.message);
    }
}
</script>

</body>
</html>