<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>GitLab Explorer</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <h1>GitLab Explorer</h1>

  {{if not .Loaded}}
  <form method="POST" action="/">
    <label for="gitlabURL">Gitlab URL:</label><br>
    <input id="gitlabURL" type="text" name="gitlabURL" required><br><br>

    <label for="token">GitLab OAuth Token:</label><br>
    <input id="token" type="password" name="token" required><br><br>

    <label for="rootGroupID">Root Group ID:</label><br>
    <input id="rootGroupID" type="number" name="rootGroupID" min="0" step="1" required><br><br>

    <button type="submit" class="primary-btn">Загрузить</button>
  </form>
  {{else}}
  <form method="POST" action="/logout">
    <button type="submit" class="primary-btn">Выйти</button>
  </form>
  {{end}}

  {{if .Error}}
  <p class="error">Ошибка: {{.Error}}</p>
  {{end}}

  {{range $i, $g := .Groups}}
  <section class="group">
    <header class="group-header" onclick="toggleGroup('group{{$i}}')">
      <span id="btn-group{{$i}}" class="toggle-btn">[+]</span>
      <h2>Группа: {{$g.Name}} ({{$g.Path}})</h2>
    </header>

    <div id="group{{$i}}" class="group-content">
      <table>
        <thead>
          <tr>
            <th>Проект</th>
            <th>
              Реф
              <select id="group-ref-{{$i}}" onchange="applyGroupRef('{{$i}}')">
                <option value="">— Массовый выбор —</option>
                {{range $r := $g.AllRefs}}<option>{{$r}}</option>{{end}}
              </select>
            </th>
            <th>Действие</th>
            <th>
              Джоб / Bridge<br>
              <input type="text" id="searchJobs-{{$i}}" placeholder="Поиск jobs" oninput="filterJobs('{{$i}}')">
            </th>
          </tr>
        </thead>
        <tbody>
          {{range $j, $p := $g.Projects}}
          <tr>
            <td>{{$p.Name}}</td>
            <td>
              <select id="ref-{{$i}}-{{$j}}">
                {{range .Refs}}<option>{{.}}</option>{{else}}<option>—</option>{{end}}
              </select>
            </td>
            <td>
              <button type="button" onclick="loadPipeline('{{$i}}','{{$j}}','{{$p.ID}}')">Загрузить пайплайн</button>
            </td>
            <td>
              <div id="pipeline-{{$i}}-{{$j}}" class="pipeline-section">
                <p id="pipeline-error-{{$i}}-{{$j}}" class="pipeline-error" style="display:none;"></p>
                <table><tbody id="jobs-{{$i}}-{{$j}}"></tbody></table>
              </div>
            </td>
          </tr>
          {{end}}
          {{if not $g.Projects}}
          <tr><td colspan="4">Нет проектов</td></tr>
          {{end}}
        </tbody>
      </table>
    </div>
  </section>
  {{end}}

  <script src="/static/app.js"></script>
</body>
</html>