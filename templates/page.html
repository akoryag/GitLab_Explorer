<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>GitLab Explorer</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <h1>GitLab Explorer</h1>

  {{if not .Loaded}}
  <form method="POST" action="/">
    <label>Gitlab URL</label><br><br>
    <input type="text" name="gitlabURL" placeholder="https://gitlab.com" pattern="https://.+" size="30" required><br><br>

    <label>GitLab OAuth Token</label><br><br>
    <input type="password" name="token" size="30" required><br><br>

    <label>Root Group ID</label><br><br>
    <input type="text" name="rootGroupID" placeholder="1111, 2222" size="30" min="0" step="1" required><br><br>

    <button type="submit" class="primary-btn">Загрузить</button>
  </form>
  {{else}}
  <form method="POST" action="/logout">
    <button type="submit" class="primary-btn">Выйти</button>
  </form>
  {{end}}

  {{if .Error}}
  <p class="error">Ошибка: {{.Error}}</p>
  {{end}}

  {{range $i, $g := .Groups}}
  <div class="group">
    <div class="group-header" onclick="toggleGroup('group{{$i}}')">
      <span id="btn-group{{$i}}" class="toggle-btn">[+]</span>
      <h2>Группа: {{$g.Name}} ({{$g.Path}})</h2>
    </div>

    <div id="group{{$i}}" class="group-content">
      <table>
        <tr>
          <th>Проект</th>
          <th>
            Реф
            <select id="group-ref-{{$i}}" onchange="applyGroupRef('{{$i}}')">
              <option value="">— Массовый выбор —</option>
              {{range $r := $g.AllRefs}}<option>{{$r}}</option>{{end}}
            </select>
          </th>
          <th>Действие</th>
          <th>
            Джоб / Bridge
            <input type="text" id="searchJobs-{{$i}}" size="30" placeholder="Поиск jobs" oninput="filterJobs('{{$i}}')">
          </th>
        </tr>
        {{range $j, $p := $g.Projects}}
        <tr>
          <td>{{.Name}}</td>
          <td>
            <select id="ref-{{$i}}-{{$j}}" style="width: 250px;">
              {{range .Refs}}<option>{{.}}</option>{{else}}<option>—</option>{{end}}
            </select>
          </td>
          <td>
            <button type="button" onclick="loadPipeline('{{$i}}', '{{$j}}', '{{$p.ID}}')" class="retry-btn">Загрузить пайплайн</button>
          </td>
          <td>
            <div id="pipeline-{{$i}}-{{$j}}" class="pipeline-section">
              <p class="pipeline-error" id="pipeline-error-{{$i}}-{{$j}}" style="display:none;"></p>
              <table>
                <tbody id="jobs-{{$i}}-{{$j}}"></tbody>
              </table>
            </div>
          </td>
        </tr>
        {{end}}
        {{if not $g.Projects}}
        <tr><td colspan="4">Нет проектов</td></tr>
        {{end}}
      </table>
    </div>
  </div>
  {{end}}

  <script src="/static/app.js"></script>
</body>
</html>
